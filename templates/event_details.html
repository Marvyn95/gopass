{% extends 'base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container">
  <div class="row justify-content-center">
    <div class="event-card col-md-8" role="region" aria-label="Event details">

      <div class="event-header">
        <div class="d-flex flex-wrap flex-column">
          <h3 class="title"
              style="background: linear-gradient(90deg, #8ec5ff, #3b82f6, #ec4899);
                     -webkit-background-clip: text;
                     background-clip: text;
                     color: transparent;
                     -webkit-text-fill-color: transparent;">
            {{ event.title }}
          </h3>

          <div class="meta text-light d-flex flex-column">
            <p class="chip">üìÖ {{ event.date.strftime('%d %b %Y') }}</p>
            <p class="chip">
              ‚è∞ {{ event.start_time.strftime('%I:%M %p') }}
              {% if event.end_time %} ‚Äî {{ event.end_time.strftime('%I:%M %p') }}{% endif %}
            </p>
            <p class="chip">üìç {{ event.location }}</p>
          </div>

          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="venue-info text-light">
              <i class="bi bi-geo-alt"> Venue: {{ event.venue }}</i>
            </div>
            
            {% if user == None and free_entry == False or user != None and user.organization_id != event.organization_id and free_entry == False %}
            <button class="btn btn-success"
                    data-bs-toggle="modal"
                    data-bs-target="#buyTicketsModal{{ event._id }}">
              <i class="bi bi-ticket-perforated"></i> Buy Tickets
            </button>
            {% endif %}

          </div>

          <!-- Buy Tickets Modal -->
          <div class="modal fade" id="buyTicketsModal{{ event._id }}" tabindex="-1"
               aria-labelledby="buyTicketsModalLabel{{ event._id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content bg-dark text-light border-0">
                <div class="modal-header py-2 border-0">
                  <h6 class="modal-title" id="buyTicketsModalLabel{{ event._id }}">Buy Tickets</h6>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <form method="POST" action="{{ url_for('buy_tickets') }}">
                  <input type="hidden" name="event_id" value="{{ event._id }}">
                  <div class="modal-body py-2">
                    <label class="form-label">Select Ticket Type</label>
                    <select class="form-select form-select-sm border-dark mb-3"
                            name="ticket_category" required>
                      <option value="">-- Choose Category --</option>
                      {% for category in event.ticket_categories.keys() %}
                        <option value="{{ category }}">
                          {{ category|title }} - UGX {{ event.ticket_categories[category] }}
                        </option>
                      {% endfor %}
                    </select>

                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control form-control-sm border-dark"
                           name="quantity" min="1" value="1" required>
                  </div>

                  <div class="modal-footer py-2 border-0">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-success btn-sm">
                      Proceed to Checkout
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Image + Details -->
        <div class="d-flex flex-wrap gap-4 align-items-start mt-3">
          {% if event.image %}
          <div class="flex-shrink-0">
            <img src="{{ url_for('static', filename='event_images/' + event.image) }}"
                 alt="{{ event.title }}"
                 style="max-width:100%; width:350px; border-radius:8px;">
          </div>
          {% endif %}

          <div class="flex-fill" style="min-width:250px">
            <div class="label text-light" style="background: linear-gradient(90deg, #8ec5ff, #3b82f6, #ec4899); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">Details</div>
            <div class="card-panel">
              {% if event.description %}
                <div class="text-light">{{ event.description }}</div>
              {% else %}
                <em class="small-muted text-light">No description provided.</em>
              {% endif %}

              <div class="d-flex gap-2 flex-wrap mt-3">
                <div class="chip text-light">üéµ Event type: {{ event.category }}</div>
                <div class="chip text-light">üé´ Tickets Available</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ticket Prices -->
      <div class="grid mb-2">
        <div class="left">
          <div class="label text-light mt-4 fs-5 fw-semibold" style="background: linear-gradient(90deg, #8ec5ff, #3b82f6, #ec4899); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">Ticket Prices</div>
          <div class="card-panel">
            {% for category, price in event.ticket_categories.items() %}
              <div class="d-flex justify-content-between py-2 border-bottom border-secondary">
                <span class="text-light">{{ category|title }}</span>
                <span class="fw-bold text-light">{% if price != '0' %}UGX {{ "{:,}".format(price|int) }}{% elif price == '0' %}üéâ Free Entry{% endif %}</span>
              </div>
            {% endfor %}
          </div>
        </div>

        <aside>
          <!-- Edit/Delete Buttons -->
          {% if user and user.role in ['admin', 'manager'] %}
          <div class="mt-4 d-flex gap-2">
            <!-- Edit Event Modal Trigger -->
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editEventModal{{ event._id }}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <!-- Delete Event Modal Trigger -->
            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteEventModal{{ event._id }}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>

          <!-- Edit Event Modal -->
          <div class="modal fade" id="editEventModal{{ event._id }}" tabindex="-1" aria-labelledby="editEventModalLabel{{ event._id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content bg-dark text-light border-0">
            <form method="POST" action="{{ url_for('edit_event') }}" enctype="multipart/form-data">
              <input type="hidden" name="event_id" value="{{ event._id }}">
              <div class="modal-header py-2 border-0">
                <h6 class="modal-title text-light" id="editEventModalLabel{{ event._id }}">Edit Event</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body py-2">
                <div class="mb-2">
                  <label for="title{{ event._id }}" class="form-label mb-1 text-light">Title</label>
                  <input type="text" id="title{{ event._id }}" class="form-control form-control-sm border-dark" name="title" value="{{ event.title }}" required>
                </div>
                <div class="mb-2">
                  <label for="description{{ event._id }}" class="form-label mb-1 text-light">Description</label>
                  <textarea id="description{{ event._id }}" class="form-control form-control-sm border-dark" name="description" rows="3" required>{{ event.description }}</textarea>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                <label for="location{{ event._id }}" class="form-label mb-1 text-light">Location</label>
                <select id="location{{ event._id }}" class="form-select form-select-sm border-dark" name="location" required>
                  <option value="{{ event.location }}" selected>{{ event.location }}</option>
                  <option>Kampala</option><option>Jinja</option><option>Mbarara</option>
                  <option>Mbale</option><option>Fort Portal</option><option>Entebbe</option>
                  <option>Wakiso</option><option>Hoima</option><option>Gulu</option><option>Arua</option>
                </select>
                  </div>
                  <div class="col-md-6 mb-2">
                <label for="venue{{ event._id }}" class="form-label mb-1 text-light">Venue</label>
                <input type="text" id="venue{{ event._id }}" class="form-control form-control-sm border-dark" name="venue" value="{{ event.venue }}" required>
                  </div>
                </div>
                <div class="mb-2">
                  <label for="image{{ event._id }}" class="form-label mb-1 text-light">Update Event Image</label>
                  <input type="file" id="image{{ event._id }}" class="form-control form-control-sm border-dark" name="event_image" accept="image/*">
                </div>
                <div class="row">
                  <div class="col-md-4 mb-2">
                <label for="date{{ event._id }}" class="form-label mb-1 text-light">Date</label>
                <input type="date" id="date{{ event._id }}" class="form-control form-control-sm border-dark" name="date" value="{{ event.date.strftime('%Y-%m-%d') }}" required>
                  </div>
                  <div class="col-md-4 mb-2">
                <label for="start_time{{ event._id }}" class="form-label mb-1 text-light">Start</label>
                <input type="time" id="start_time{{ event._id }}" class="form-control form-control-sm border-dark" name="start_time" value="{{ event.start_time.strftime('%H:%M') }}" required>
                  </div>
                  <div class="col-md-4 mb-2">
                <label for="end_time{{ event._id }}" class="form-label mb-1 text-light">End</label>
                <input type="time" id="end_time{{ event._id }}" class="form-control form-control-sm border-dark" name="end_time" value="{{ event.end_time.strftime('%H:%M') }}" required>
                  </div>
                </div>
                <div class="mb-2">
                  <label for="category{{ event._id }}" class="form-label mb-1 text-light">Event Category</label>
                  <select id="category{{ event._id }}" class="form-select form-select-sm border-dark" name="category" required>
                <option value="{{ event.category }}" selected>{{ event.category }}</option>
                <option>Music</option>
                <option>Sports</option>
                <option>Conference</option>
                <option>Workshop</option>
                <option>Seminar</option>
                <option>Festival</option>
                <option>Meetup</option>
                <option>Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label text-light">Ticket Categories</label>
                  <div id="ticket-types-list">
                {% for key, value in event.ticket_categories.items() %}
                <div class="input-group mb-2 ticket-type-item">
                  <input type="text" class="form-control border-dark me-1" name="ticket_types[]" value="{{ key }}" required>
                  <input type="number" class="form-control border-dark" name="ticket_prices[]" value="{{ value }}" min="0" step="0.01" required>
                  <button type="button" class="btn btn-outline-danger remove-ticket-type" title="Remove">&times;</button>
                </div>
                {% endfor %}
                <div class="input-group mb-2 ticket-type-item">
                  <input type="text" class="form-control border-dark me-1" name="ticket_types[]" placeholder="Category">
                  <input type="number" class="form-control border-dark" name="ticket_prices[]" placeholder="Price" min="0" step="0.01">
                  <button type="button" class="btn btn-outline-danger remove-ticket-type" title="Remove">&times;</button>
                </div>
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm mt-1" id="add-ticket-type">Add Category</button>
                </div>
              </div>
              <div class="modal-footer py-2 border-0">
                <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
              </div>
            </form>
              </div>
            </div>
          </div>

          <!-- Delete Event Modal -->
          <div class="modal fade" id="deleteEventModal{{ event._id }}" tabindex="-1" aria-labelledby="deleteEventModalLabel{{ event._id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
              <div class="modal-content bg-dark text-light border-0">
            <form method="POST" action="{{ url_for('delete_event')}}">
                <input type="hidden" name="event_id" value="{{ event._id }}">
              <div class="modal-header py-2 border-0">
                <h6 class="modal-title text-light" id="deleteEventModalLabel{{ event._id }}">Delete Event</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body py-2">
                <p>Are you sure you want to delete this event?</p>
              </div>
              <div class="modal-footer py-2 border-0">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </div>
            </form>
              </div>
            </div>
          </div>
          {% endif %}
        </aside>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener('click', function(e) {
    if (e.target.id && e.target.id.startsWith('add-ticket-type')) {
      const ticketTypesList = e.target.closest('.modal-body').querySelector('[id$="-list"]');
      const div = document.createElement('div');
      div.className = 'input-group mb-2 ticket-type-item';
      div.innerHTML = `
        <input type="text" class="form-control border-dark" name="ticket_types[]" placeholder="Category" required>
        <input type="number" class="form-control border-dark" name="ticket_prices[]" placeholder="Price" min="0" step="0.01" required>
        <button type="button" class="btn btn-outline-danger remove-ticket-type" title="Remove">&times;</button>
      `;
      ticketTypesList.appendChild(div);
    }
    if (e.target.classList.contains('remove-ticket-type')) {
      const item = e.target.closest('.ticket-type-item');
      const ticketTypesList = item.closest('[id$="-list"]');
      if (ticketTypesList.children.length > 1) item.remove();
    }
  });
</script>

{% endblock %}